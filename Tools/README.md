# TOOLS

## Docker
Contains the docker images used by the backend
* [CI](Docker/CI/Dockerfile)

## Scripts
Contains scripts to automate tasks related to BioStudies

### Summarize Stats
Calculates the total data size for the studies from the CVS file generated by the stats job. The file from the previous
month (which is expected to be located in the given output path) will be used as base for the current month's results.

#### Parameters
* $1 -> The path of the stats file to process
* $2 -> The path to place the new generated file with the current month size

#### Execution
Assuming that the script is executed on 05/10/2018, the reports folder should contain the following files with the
results for the previous month:

* 201808_BIA.txt
* 201808_BioStudies.txt

```
./SummarizeStats /path/to/stats/stats.csv /path/to/reports
```

The script will produce the following files in `/path/to/reports` folder:
* 201809_BIA.txt
* 201809_BioStudies.txt

### Generate Files
Generates the JSON attributes and SQL commands to insert the files for a submission.

#### Parameters
* $1 -> Folder containing the submission files
* $2 -> Study root section id
* $3 -> Base path for submission files

#### Execution
```
./GenerateFiles.sh /home/user/imaging-files 123456 /a/base/path
```
output.json

```json
[
  { "path": "/a/base/path/file1.txt", "size": "1234", "type": "file" },
  { "path": "/a/base/path/file2.txt", "size": "5678", "type": "file" }
]

```

output.sql
```sql
INSERT INTO FileRef(directory, name, size, tableIndex, sectionId, ord, path) VALUES(0, '/a/base/path/file1.txt', 1234, 0, 123456, 0, 'u/a/base/path/file1.txt');
INSERT INTO FileRef(directory, name, size, tableIndex, sectionId, ord, path) VALUES(0, '/a/base/path/file2.txt', 5678, 0, 123456, 1, 'u/a/base/path/file2.txt');
```

### Generate Files With Attributes
Generates the attributes and SQL commands to insert the files for an imaging submission adding the attributes based on a
database table

#### Attributes Table
The attributes should be stored in a database table called `ImagingFilesAttributes` with the following columns (vararg):
* file (PK)
* plate
* well
* replicate
* channel
* spot
* cellLineName
* mutation
* compoundId
* compoundName

#### Parameters
* $1 -> Folder containing the imaging files
* $2 -> Study root section id
* $3 -> Initial file id. This will be used as the first id for the SQL auto-generated id column. Next files will be id + 1.
* $4 -> Base path for files

#### Execution
```
./GenerateFilesWithAttributes.sh /home/user/imaging-files 123456 789 /a/base/path
```

output.json
```json
[
  {
    "path": "/a/base/path/file1.txt",
    "size": "1234",
    "attributes": [
      {"name": "Plate", "value": "A01"},
      {"name": "Well", "value": "B01"},
      {"name": "Replicate", "value": "true"},
      {"name": "Channel", "value": "2"},
      {"name": "Spot", "value": "spot1"},
      {"name": "Cell Line Name", "value": "Cell Line 1"},
      {"name": "Mutation", "value": "MXY012"},
      {"name": "Compound Id", "value": "123"},
      {"name": "Compound Name", "value": "Compound1"}
    ],
    "type": "file"
  },
  {
    "path": "/a/base/path/file2.txt",
    "size": "5678",
    "attributes": [
      {"name": "Plate", "value": "A02"},
      {"name": "Well", "value": "B02"},
      {"name": "Replicate", "value": "false"},
      {"name": "Channel", "value": "3"},
      {"name": "Spot", "value": "spot2"},
      {"name": "Cell Line Name", "value": "Cell Line 2"},
      {"name": "Mutation", "value": "MXY013"},
      {"name": "Compound Id", "value": "124"},
      {"name": "Compound Name", "value": "Compound2"}
    ],
    "type": "file"
  }
]
```

output.sql
```sql
INSERT INTO FileRef(id, directory, name, size, tableIndex, sectionId, ord, path) VALUES(789, 0, '/a/base/path/file1.txt', 1234, 0, 123456, 0, 'u/a/base/path/file1.txt');
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(789, "Plate", "A01", 0, 0, 0);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(789, "Well", "B01", 0, 0, 1);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(789, "Replicate", "true", 0, 0, 2);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(789, "Channel", "2", 0, 0, 3);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(789, "Spot", "spot1", 0, 0, 4);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(789, "Cell Line Name", "Cell Line 1", 0, 0, 5);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(789, "Mutation", "MXY012", 0, 0, 6);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(789, "Compound Id", "123", 0, 0, 7);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(789, "Compound Name", "Compound1", 0, 0, 8);
INSERT INTO FileRef(id, directory, name, size, tableIndex, sectionId, ord, path) VALUES(790, 0, '/a/base/path/file2.txt', 5678, 0, 123456, 1, 'u/a/base/path/file2.txt');
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(790, "Plate", "A02", 0, 0, 0);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(790, "Well", "B02", 0, 0, 1);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(790, "Replicate", "false", 0, 0, 2);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(790, "Channel", "3", 0, 0, 3);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(790, "Spot", "spot2", 0, 0, 4);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(790, "Cell Line Name", "Cell Line 2", 0, 0, 5);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(790, "Mutation", "MXY013", 0, 0, 6);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(790, "Compound Id", "124", 0, 0, 7);
INSERT INTO FileAttribute(file_id, name, value, numValue, reference, ord) VALUES(790, "Compound Name", "Compound2", 0, 0, 8);
```
